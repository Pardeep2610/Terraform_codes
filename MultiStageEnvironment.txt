name: "todo-infra-app"
trigger: none
parameters:
  - name: abc
    displayName: "environment"
    default: dev
    values:
      - dev
      - qa
      - prod
      

stages:
  - stage: terraformstage
    displayName: TerraformStage
    jobs:
      - job: terraforminitplan
        pool:
          name: TODO-INFRA-AGENT 
        displayName: "TerraformTask"
        steps:
          - task: TerraformTask@5
            displayName: terraforminit
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: '$(System.DefaultWorkingDirectory)/Environment/dev'
              backendServiceArm: 'Infra-sc'
              backendAzureRmResourceGroupName: 'maheshrg1'
              backendAzureRmStorageAccountName: 'maheshsvc'
              backendAzureRmContainerName: 'pardeepstatefile'
              backendAzureRmKey: '{{parameters.environment}}.tfstate'
          - task: TerraformTask@5
            displayName: terraformValidate
            inputs:
              provider: 'azurerm'
              command: 'validate'
              workingDirectory: '$(System.DefaultWorkingDirectory)/Environment/dev'
          - task: TerraformTask@5
            displayName: terraformplan
            inputs:
              provider: 'azurerm'
              command: 'plan'
              workingDirectory: '$(System.DefaultWorkingDirectory)/Environment/dev'
              commandOptions: '-var-file=${{parameters.abc}}.auto.tfvars'
              environmentServiceNameAzureRM: 'Infra-sc'


      - job: manualvalidation
        dependsOn: terraforminitplan
        pool: server
        displayName: ManualValidation
        steps:

        - task: ManualValidation@1
          inputs:
            notifyUsers: 'pardeepkumar02610@gmail.com'
            approvers: 'pardeepkumar02610@gmail.com'
          env:
            TF_VAR_vm1_username: $(vm1_username)
            TF_VAR_vm1_password: $(vm1_password)
            TF_VAR_vm2_username: $(vm2_username)
            TF_VAR_vm2_password: $(vm2_password)
              

      - job: terraformapply
        dependsOn: manualvalidation
        pool:
          name: TODO-INFRA-AGENT 
        steps:
          - task: TerraformInstaller@1
            inputs:
              terraformVersion: 'latest'

          - task: TerraformTask@5
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: '$(System.DefaultWorkingDirectory)/Environment/dev'
              backendServiceArm: 'Infra-sc'
              backendAzureRmResourceGroupName: 'maheshrg1'
              backendAzureRmStorageAccountName: 'maheshsvc'
              backendAzureRmContainerName: 'pardeepstatefile'
              backendAzureRmKey: 'todoapp.tfstate'
          - task: TerraformTask@5
            displayName: TerraformApply
            inputs:
              provider: 'azurerm'
              command: 'apply'
              workingDirectory: '$(System.DefaultWorkingDirectory)/Environment/dev'
              environmentServiceNameAzureRM: 'Infra-sc'
           
              
